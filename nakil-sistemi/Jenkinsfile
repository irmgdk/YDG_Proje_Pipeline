pipeline {
    agent any
    tools {
        jdk 'JDK'
    }
    environment {
        DOCKER_IMAGE_NAME = 'nakil-sistemi'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        MAVEN_OPTS = "-Djacoco.skip=true -Dfile.encoding=UTF-8 -DskipSeleniumTests=true"
        SELENIUM_GRID_URL = "http://localhost:4444/wd/hub"
        // Docker container'dan host'a eri≈üim i√ßin host.docker.internal kullan
        APP_URL = "http://host.docker.internal:8080/mahkum-nakil"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo '‚úÖ Github kodlarƒ± √ßekildi'
            }
        }

        stage('Build') {
            steps {
                dir('nakil-sistemi') {
                    // Sadece derle, Selenium testlerini atla
                    bat 'mvn clean compile -DskipSeleniumTests'
                    echo '‚úÖ Proje ba≈üarƒ±yla derlendi'
                }
            }
        }

        stage('1. Asama: Unit Tests (Service Layer)') {
            stages {
                stage('1.1 AracService Unit Tests') {
                    stages {
                        stage('Test 1: tumAraclar_ShouldReturnAllAraclar') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#tumAraclar_ShouldReturnAllAraclar' } }
                        }
                        stage('Test 2: aracBul_WithValidPlaka_ShouldReturnArac') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#aracBul_WithValidPlaka_ShouldReturnArac' } }
                        }
                        stage('Test 3: aracKaydet_NewArac_ShouldSaveSuccessfully') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#aracKaydet_NewArac_ShouldSaveSuccessfully' } }
                        }
                        stage('Test 4: aracKaydet_DuplicatePlaka_ShouldThrowException') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#aracKaydet_DuplicatePlaka_ShouldThrowException' } }
                        }
                        stage('Test 5: aracKaydet_InvalidPlakaFormat_ShouldThrowException') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#aracKaydet_InvalidPlakaFormat_ShouldThrowException' } }
                        }
                        stage('Test 6: aracSil_ValidId_ShouldDeleteSuccessfully') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#aracSil_ValidId_ShouldDeleteSuccessfully' } }
                        }
                        stage('Test 7: aktifAraclar_ShouldReturnOnlyActiveAraclar') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#aktifAraclar_ShouldReturnOnlyActiveAraclar' } }
                        }
                        stage('Test 8: m√ºsaitAraclar_ShouldReturnAvailableAraclar') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#m√ºsaitAraclar_ShouldReturnAvailableAraclar' } }
                        }
                        stage('Test 9: tipeGoreAraclar_ShouldReturnFilteredAraclar') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#tipeGoreAraclar_ShouldReturnFilteredAraclar' } }
                        }
                        stage('Test 10: aracDurumGuncelle_ShouldUpdateAktifStatus') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#aracDurumGuncelle_ShouldUpdateAktifStatus' } }
                        }
                        stage('Test 11: aracBakimaAl_ShouldUpdateBakimdaStatus') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#aracBakimaAl_ShouldUpdateBakimdaStatus' } }
                        }
                        stage('Test 12: plakaVarMi_ShouldReturnTrueIfExists') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#plakaVarMi_ShouldReturnTrueIfExists' } }
                        }
                        stage('Test 13: aramaYap_ShouldReturnMatchingAraclar') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#aramaYap_ShouldReturnMatchingAraclar' } }
                        }
                        stage('Test 14: toplamAracSayisi_ShouldReturnCount') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest#toplamAracSayisi_ShouldReturnCount' } }
                        }
                    }
                }

                stage('1.2 MahkumService Unit Tests') {
                    stages {
                        stage('Test 1: tumMahkumlar_ShouldReturnAllMahkumlar') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#tumMahkumlar_ShouldReturnAllMahkumlar' } }
                        }
                        stage('Test 2: mahkumBul_WithValidId_ShouldReturnMahkum') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#mahkumBul_WithValidId_ShouldReturnMahkum' } }
                        }
                        stage('Test 3: mahkumBul_WithInvalidId_ShouldReturnEmpty') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#mahkumBul_WithInvalidId_ShouldReturnEmpty' } }
                        }
                        stage('Test 4: mahkumKaydet_NewMahkum_ShouldSaveSuccessfully') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#mahkumKaydet_NewMahkum_ShouldSaveSuccessfully' } }
                        }
                        stage('Test 5: mahkumKaydet_DuplicateTcKimlik_ShouldThrowException') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#mahkumKaydet_DuplicateTcKimlik_ShouldThrowException' } }
                        }
                        stage('Test 6: mahkumKaydet_InvalidTcKimlikFormat_ShouldThrowException') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#mahkumKaydet_InvalidTcKimlikFormat_ShouldThrowException' } }
                        }
                        stage('Test 7: mahkumSil_ValidId_ShouldDeleteSuccessfully') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#mahkumSil_ValidId_ShouldDeleteSuccessfully' } }
                        }
                        stage('Test 8: mahkumSil_InvalidId_ShouldThrowException') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#mahkumSil_InvalidId_ShouldThrowException' } }
                        }
                        stage('Test 9: riskeGoreAra_ShouldReturnFilteredMahkumlar') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#riskeGoreAra_ShouldReturnFilteredMahkumlar' } }
                        }
                        stage('Test 10: aktifMahkumlar_ShouldReturnOnlyActiveMahkumlar') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#aktifMahkumlar_ShouldReturnOnlyActiveMahkumlar' } }
                        }
                        stage('Test 11: adVeyaSoyadaGoreAra_ShouldReturnMatchingMahkumlar') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#adVeyaSoyadaGoreAra_ShouldReturnMatchingMahkumlar' } }
                        }
                        stage('Test 12: toplamMahkumSayisi_ShouldReturnCount') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest#toplamMahkumSayisi_ShouldReturnCount' } }
                        }
                    }
                }

                stage('1.3 NakilGoreviService Unit Tests') {
                    stages {
                        stage('Test 1: tumGorevleriGetir_ShouldReturnAllGorevler') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#tumGorevleriGetir_ShouldReturnAllGorevler' } }
                        }
                        stage('Test 2: gorevBul_WithValidId_ShouldReturnGorev') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#gorevBul_WithValidId_ShouldReturnGorev' } }
                        }
                        stage('Test 3: gorevKaydet_NewGorev_ShouldSaveSuccessfully') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#gorevKaydet_NewGorev_ShouldSaveSuccessfully' } }
                        }
                        stage('Test 4: gorevKaydet_WithoutSofor_ShouldThrowException') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#gorevKaydet_WithoutSofor_ShouldThrowException' } }
                        }
                        stage('Test 5: gorevBaslat_ValidGorev_ShouldUpdateStatus') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#gorevBaslat_ValidGorev_ShouldUpdateStatus' } }
                        }
                        stage('Test 6: gorevBaslat_WithoutArac_ShouldThrowException') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#gorevBaslat_WithoutArac_ShouldThrowException' } }
                        }
                        stage('Test 7: gorevTamamla_ValidGorev_ShouldUpdateStatus') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#gorevTamamla_ValidGorev_ShouldUpdateStatus' } }
                        }
                        stage('Test 8: gorevTamamla_NotInProgress_ShouldThrowException') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#gorevTamamla_NotInProgress_ShouldThrowException' } }
                        }
                        stage('Test 9: gorevSil_PlannedGorev_ShouldDeleteSuccessfully') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#gorevSil_PlannedGorev_ShouldDeleteSuccessfully' } }
                        }
                        stage('Test 10: gorevSil_CompletedGorev_ShouldThrowException') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#gorevSil_CompletedGorev_ShouldThrowException' } }
                        }
                        stage('Test 11: durumaGoreGorevler_ShouldReturnFilteredGorevler') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#durumaGoreGorevler_ShouldReturnFilteredGorevler' } }
                        }
                        stage('Test 12: aktifGorevler_ShouldReturnActiveGorevler') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#aktifGorevler_ShouldReturnActiveGorevler' } }
                        }
                        stage('Test 13: getIstatistikler_ShouldReturnStatistics') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest#getIstatistikler_ShouldReturnStatistics' } }
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('2. Asama: Integration Tests (Controller)') {
            stages {
                stage('2.1 MahkumController Integration Tests') {
                    stages {
                        stage('Test 1: listMahkumlar_ShouldReturnMahkumListPage') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumControllerIT#listMahkumlar_ShouldReturnMahkumListPage' } }
                        }
                        stage('Test 2: showAddForm_ShouldReturnAddFormPage') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumControllerIT#showAddForm_ShouldReturnAddFormPage' } }
                        }
                        stage('Test 3: saveMahkum_NewMahkum_ShouldSaveAndRedirect') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumControllerIT#saveMahkum_NewMahkum_ShouldSaveAndRedirect' } }
                        }
                        stage('Test 4: saveMahkum_InvalidData_ShouldReturnToFormWithError') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumControllerIT#saveMahkum_InvalidData_ShouldReturnToFormWithError' } }
                        }
                        stage('Test 5: showEditForm_ValidId_ShouldReturnEditForm') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumControllerIT#showEditForm_ValidId_ShouldReturnEditForm' } }
                        }
                        stage('Test 6: deleteMahkum_ValidId_ShouldDeleteAndRedirect') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumControllerIT#deleteMahkum_ValidId_ShouldDeleteAndRedirect' } }
                        }
                        stage('Test 7: deleteMahkum_ServiceThrowsException_ShouldShowError') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumControllerIT#deleteMahkum_ServiceThrowsException_ShouldShowError' } }
                        }
                        stage('Test 8: searchByRisk_ValidRisk_ShouldReturnFilteredList') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumControllerIT#searchByRisk_ValidRisk_ShouldReturnFilteredList' } }
                        }
                        stage('Test 9: searchByRisk_InvalidRisk_ShouldShowAllWithError') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumControllerIT#searchByRisk_InvalidRisk_ShouldShowAllWithError' } }
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('3. Asama: Repository Integration Tests') {
            stages {
                stage('3.1 MahkumRepository Integration Tests') {
                    stages {
                        stage('Test 1: findByTcKimlik_ShouldReturnMahkum') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumRepositoryIntegrationTest#findByTcKimlik_ShouldReturnMahkum' } }
                        }
                        stage('Test 2: findByRiskSeviyesi_ShouldReturnFilteredMahkumlar') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumRepositoryIntegrationTest#findByRiskSeviyesi_ShouldReturnFilteredMahkumlar' } }
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('4. Asama: Package Application') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    echo 'üì¶ Uygulama paketleniyor...'
                    // T√ºm testleri atlayarak paketle (Selenium hari√ß zaten √ßalƒ±≈ütƒ±rƒ±ldƒ±)
                    bat 'mvn package -DskipTests -DskipSeleniumTests'
                    echo '‚úÖ Uygulama ba≈üarƒ±yla paketlendi'
                }
            }
        }

        stage('5. Asama: Docker Build and Run') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    script {
                        echo 'üê≥ Docker konteynerleri hazƒ±rlanƒ±yor...'

                        // √ñnceki konteynerleri temizle
                        bat 'docker-compose down --remove-orphans'

                        // Yeni imaj olu≈ütur
                        bat 'docker-compose build --no-cache app'

                        // T√ºm servisleri ba≈ülat
                        bat 'docker-compose up -d'

                        // Sistemlerin ba≈ülamasƒ±nƒ± bekle
                        echo '‚è≥ Sistemlerin ba≈ülamasƒ± bekleniyor (60 saniye)...'
                        sleep 60

                        // Health check'leri kontrol et
                        echo 'ü©∫ Health check kontrol ediliyor...'
                        bat 'docker-compose ps'

                        // App health check i√ßin retry mekanizmasƒ±
                        echo 'üîç Uygulama health check yapƒ±lƒ±yor...'
                        script {
                            def healthCheckPassed = false
                            def maxRetries = 12 // 60 saniye (12 * 5 saniye)
                            def retryCount = 0

                            while (!healthCheckPassed && retryCount < maxRetries) {
                                try {
                                    // Windows i√ßin uygun health check
                                    bat 'curl -s -o nul -w "%%{http_code}" http://localhost:8080/mahkum-nakil/actuator/health | findstr /R /C:"200"'
                                    healthCheckPassed = true
                                    echo '‚úÖ Uygulama health check ba≈üarƒ±lƒ±'
                                } catch (Exception e) {
                                    retryCount++
                                    echo "‚ùå Health check ba≈üarƒ±sƒ±z (Deneme ${retryCount}/${maxRetries}), 5 saniye bekleniyor..."
                                    sleep 5
                                }
                            }

                            if (!healthCheckPassed) {
                                echo '‚ö†Ô∏è  Uygulama health check ge√ßemedi, devam ediliyor...'
                                currentBuild.result = 'UNSTABLE'
                            }

                            // Selenium Grid health check
                            try {
                                bat 'curl -s -o nul -w "%%{http_code}" http://localhost:4444/wd/hub/status | findstr /R /C:"200"'
                                echo '‚úÖ Selenium Grid ba≈üarƒ±yla ba≈üladƒ±'
                            } catch (Exception e) {
                                echo '‚ö†Ô∏è  Selenium Grid health check ba≈üarƒ±sƒ±z, devam ediliyor...'
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }
            }
        }

        stage('6. Asama: Selenium Testleri') {
            stages {
                stage('6.1 Arac Selenium Testleri') {
                    stages {
                        stage('Senaryo 1: Arac Listeleme Sayfasi Yukleme') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracSeleniumTest#testAracListPageLoads' } }
                        }
                        stage('Senaryo 2: Yeni Arac Ekleme') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracSeleniumTest#testAddNewArac' } }
                        }
                        stage('Senaryo 3: Arac Arama') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracSeleniumTest#testSearchArac' } }
                        }
                        stage('Senaryo 4: Arac Durum Degistirme') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracSeleniumTest#testAracStatusToggle' } }
                        }
                    }
                }

                stage('6.2 Dashboard Selenium Testleri') {
                    stages {
                        stage('Senaryo 1: Ana Sayfa Yukleme') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=DashboardSeleniumTest#testHomePageLoadsSuccessfully' } }
                        }
                        stage('Senaryo 2: Dashboard Istatistikleri') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=DashboardSeleniumTest#testDashboardStatisticsDisplayed' } }
                        }
                        stage('Senaryo 3: Navigasyon Linkleri') {
                            steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=DashboardSeleniumTest#testNavigationLinksWork' } }
                        }
                    }
                }
            }
            post {
                always {
                    // Test raporlarƒ±nƒ± kaydet
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'

                    // Ekran g√∂r√ºnt√ºlerini sakla (varsa)
                    archiveArtifacts artifacts: 'nakil-sistemi/target/screenshots/*.png', allowEmptyArchive: true
                }
            }
        }
    }

    post {
        always {
            dir('nakil-sistemi') {
                script {
                    echo 'üßπ Docker konteynerleri temizleniyor...'
                    // Konteynerleri durdur
                    bat 'docker-compose down --remove-orphans -v || echo "Docker compose down ba≈üarƒ±sƒ±z"'
                }
            }

            script {
                echo "üìä Build Sonucu: ${currentBuild.result}"

                // T√ºm test raporlarƒ±nƒ± topla
                def testResults = junit testResults: '**/target/surefire-reports/*.xml', allowEmptyResults: true
                if (testResults.totalCount > 0) {
                    echo "Toplam Test: ${testResults.totalCount}"
                    echo "‚úÖ Ba≈üarƒ±lƒ± Test: ${testResults.passCount}"
                    echo "‚ùå Ba≈üarƒ±sƒ±z Test: ${testResults.failCount}"
                    echo "‚è≠Ô∏è  Atlanan Test: ${testResults.skipCount}"

                    def successRate = (testResults.passCount / testResults.totalCount) * 100
                    echo "üìà Ba≈üarƒ± Oranƒ±: ${String.format("%.2f", successRate)}%"

                    // Detaylƒ± test a≈üamalarƒ± raporu
                    echo "üìã Detaylƒ± Test A≈üamalarƒ±:"
                    echo "  1. Asama: Service Unit Tests (39 test metod)"
                    echo "    ‚Ä¢ AracServiceTest: 14 test"
                    echo "    ‚Ä¢ MahkumServiceTest: 12 test"
                    echo "    ‚Ä¢ NakilGoreviServiceTest: 13 test"
                    echo "  2. Asama: Controller Integration Tests (9 test metod)"
                    echo "    ‚Ä¢ MahkumControllerIT: 9 test"
                    echo "  3. Asama: Repository Integration Tests (2 test metod)"
                    echo "    ‚Ä¢ MahkumRepositoryIntegrationTest: 2 test"
                    echo "  6. Asama: Selenium Tests (7 senaryo)"
                    echo "    ‚Ä¢ AracSeleniumTest: 4 senaryo"
                    echo "    ‚Ä¢ DashboardSeleniumTest: 3 senaryo"
                    echo "  TOPLAM: 57 test metod/senaryo"
                }

                // Sonu√ß deƒüerlendirme
                if (currentBuild.result == 'FAILURE') {
                    echo '‚ùå Pipeline FAILURE ile sonu√ßlandƒ±'
                    error('‚ùå Pipeline FAILURE ile sonu√ßlandƒ±!')
                } else if (currentBuild.result == 'UNSTABLE') {
                    echo '‚ö†Ô∏è  Pipeline UNSTABLE ile tamamlandƒ± (bazƒ± testler ba≈üarƒ±sƒ±z veya uyarƒ±lar var)'
                } else {
                    echo '‚úÖ Pipeline SUCCESS ile tamamlandƒ±!'
                }
            }

            // Temizlik
            bat 'del /Q *.log 2>nul || echo "Log dosyalarƒ± silinemedi"'
            bat 'del /Q nakil-sistemi\\target\\screenshots\\*.png 2>nul || echo "Screenshot dosyalarƒ± silinemedi"'
        }
    }
}