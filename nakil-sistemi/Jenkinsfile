pipeline {
    agent any
    tools {
        jdk 'JDK'
    }
    environment {
        DOCKER_IMAGE_NAME = 'nakil-sistemi'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        MAVEN_OPTS = "-Djacoco.skip=true -Dfile.encoding=UTF-8"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo '✅ Github kodları çekildi'
            }
        }

        stage('Build') {
            steps {
                dir('nakil-sistemi') {
                    bat 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Unit Tests') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            // Sadece unit testleri çalıştır
                            bat 'mvn test -Dtest="*Test" -DskipITs -DskipSeleniumTests'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "Unit Tests failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Integration Tests') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            // Sadece integration testleri çalıştır
                            bat 'mvn verify -DskipUnitTests -DskipSeleniumTests'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "Integration Tests failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/failsafe-reports/*.xml'
                }
            }
        }

        stage('Repository Tests') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            // Sadece repository testleri çalıştır
                            bat 'mvn test -Dtest="*Repository*Test" -DskipITs -DskipSeleniumTests'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "Repository Tests failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Docker Run') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    bat 'docker-compose down'
                    bat 'docker-compose up -d'
                    sleep 40 // Sistemin tamamen açılması için
                }
            }
        }

        stage('Selenium Tests') {
            when {
                expression {
                    // Selenium testlerini şimdilik atla, sonra etkinleştir
                    false && currentBuild.result != 'FAILURE'
                }
            }
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            bat 'mvn test -Dtest="*SeleniumTest" -DskipUnitTests -DskipITs'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "Selenium Tests failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }
    }

    post {
        always {
            dir('nakil-sistemi') {
                bat 'docker-compose down'
            }
            script {
                // Test sonuçlarını yazdır
                echo "Build Result: ${currentBuild.result}"
                if (currentBuild.result == 'FAILURE') {
                    error('Pipeline failed!')
                } else if (currentBuild.result == 'UNSTABLE') {
                    echo 'Pipeline completed with warnings'
                } else {
                    echo '✅ Pipeline başarıyla tamamlandı!'
                }
            }
        }
    }
}