pipeline {
    agent any
    tools {
        jdk 'JDK'
    }
    environment {
        DOCKER_IMAGE_NAME = 'nakil-sistemi'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        MAVEN_OPTS = "-Djacoco.skip=true -Dfile.encoding=UTF-8 -DskipSeleniumTests=true"
        SELENIUM_GRID_URL = "http://localhost:4444/wd/hub"
        APP_URL = "http://host.docker.internal:8080/mahkum-nakil"
    }

    stages {
        stage('Checkout 1') {
            steps {
                checkout scm
                echo 'âœ… Github kodlarÄ± Ã§ekildi'
            }
        }

        stage('Build') {
            steps {
                dir('nakil-sistemi') {
                    bat 'mvn clean compile -DskipSeleniumTests'
                    echo 'âœ… Proje baÅŸarÄ±yla derlendi'
                }
            }
        }

        // TEST SCENARIOS - BÃ–LÃœM 1: SERVICE LAYER TESTS
        stage('Scenario 1: AracService Unit Tests') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo 'ğŸ§ª AracService Unit Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                            bat 'mvn test -Dtest="AracServiceTest" -DfailIfNoTests=false'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "AracServiceTest failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Scenario 2: MahkumService Unit Tests') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo 'ğŸ§ª MahkumService Unit Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                            bat 'mvn test -Dtest="MahkumServiceTest" -DfailIfNoTests=false'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "MahkumServiceTest failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Scenario 3: NakilGoreviService Unit Tests') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo 'ğŸ§ª NakilGoreviService Unit Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                            bat 'mvn test -Dtest="NakilGoreviServiceTest" -DfailIfNoTests=false'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "NakilGoreviServiceTest failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        // TEST SCENARIOS - BÃ–LÃœM 2: INTEGRATION TESTS
        stage('Scenario 4: MahkumController Integration Tests') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo 'ğŸ”— MahkumController Integration Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                            bat 'mvn test -Dtest="MahkumControllerIT" -DfailIfNoTests=false'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "MahkumControllerIT failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Scenario 5: MahkumRepository Integration Tests') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo 'ğŸ—„ï¸  MahkumRepository Integration Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                            bat 'mvn test -Dtest="MahkumRepositoryIntegrationTest" -DfailIfNoTests=false'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "MahkumRepositoryIntegrationTest failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        // TEST SCENARIOS - BÃ–LÃœM 3: SELENIUM TESTS
        stage('Package Application') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    echo 'ğŸ“¦ Uygulama paketleniyor...'
                    bat 'mvn package -DskipTests -DskipSeleniumTests'
                    echo 'âœ… Uygulama baÅŸarÄ±yla paketlendi'
                }
            }
        }

        stage('Docker Build and Run') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    script {
                        echo 'ğŸ³ Docker konteynerleri hazÄ±rlanÄ±yor...'
                        bat 'docker-compose down --remove-orphans'
                        bat 'docker-compose build --no-cache app'
                        bat 'docker-compose up -d'
                        echo 'â³ Sistemlerin baÅŸlamasÄ± bekleniyor (60 saniye)...'
                        sleep 60

                        echo 'ğŸ©º Health check kontrol ediliyor...'
                        bat 'docker-compose ps'

                        script {
                            def healthCheckPassed = false
                            def maxRetries = 12
                            def retryCount = 0

                            while (!healthCheckPassed && retryCount < maxRetries) {
                                try {
                                    bat 'curl -s -o nul -w "%%{http_code}" http://localhost:8080/mahkum-nakil/actuator/health | findstr /R /C:"200"'
                                    healthCheckPassed = true
                                    echo 'âœ… Uygulama health check baÅŸarÄ±lÄ±'
                                } catch (Exception e) {
                                    retryCount++
                                    echo "âŒ Health check baÅŸarÄ±sÄ±z (Deneme ${retryCount}/${maxRetries}), 5 saniye bekleniyor..."
                                    sleep 5
                                }
                            }

                            if (!healthCheckPassed) {
                                echo 'âš ï¸  Uygulama health check geÃ§emedi, devam ediliyor...'
                                currentBuild.result = 'UNSTABLE'
                            }

                            try {
                                bat 'curl -s -o nul -w "%%{http_code}" http://localhost:4444/wd/hub/status | findstr /R /C:"200"'
                                echo 'âœ… Selenium Grid baÅŸarÄ±yla baÅŸladÄ±'
                            } catch (Exception e) {
                                echo 'âš ï¸  Selenium Grid health check baÅŸarÄ±sÄ±z, devam ediliyor...'
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }
            }
        }

        stage('Scenario 6: Arac Selenium Tests') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo 'ğŸš€ Arac Selenium testleri baÅŸlatÄ±lÄ±yor...'
                            echo 'â³ Selenium Grid hazÄ±rlanÄ±yor...'
                            sleep 30

                            bat '''
                                curl -f http://localhost:4444/wd/hub/status || (
                                    echo "âŒ Selenium Grid hazÄ±r deÄŸil"
                                    exit 1
                                )
                            '''

                            echo 'ğŸ¯ Arac Selenium Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                            bat '''
                                mvn test -Dtest="AracSeleniumTest" -DfailIfNoTests=false ^
                                  -Dselenium.grid.url=http://localhost:4444/wd/hub ^
                                  -Dapp.url=http://host.docker.internal:8080/mahkum-nakil ^
                                  -Dspring.main.web-application-type=none ^
                                  -DskipITs=true ^
                                  -DskipUTs=true
                            '''

                            echo 'âœ… Arac Selenium testleri baÅŸarÄ±yla tamamlandÄ±'

                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "âš ï¸  AracSeleniumTest failed: ${e.message}"

                            bat '''
                                docker-compose logs --tail=200 app > app-arac-selenium-error.log 2>&1
                                docker-compose logs --tail=200 selenium-hub > selenium-hub-error.log 2>&1
                                docker-compose logs --tail=200 chrome-node > chrome-node-error.log 2>&1
                                docker-compose ps > docker-ps.log 2>&1
                            '''

                            archiveArtifacts artifacts: '*error.log, docker-ps.log', allowEmptyArchive: true
                            archiveArtifacts artifacts: 'target/screenshots/*.png', allowEmptyArchive: true
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                    archiveArtifacts artifacts: 'nakil-sistemi/*.png', allowEmptyArchive: true
                }
            }
        }

        stage('Scenario 7: Dashboard Selenium Tests') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo 'ğŸš€ Dashboard Selenium testleri baÅŸlatÄ±lÄ±yor...'
                            echo 'â³ Selenium Grid hazÄ±rlanÄ±yor...'
                            sleep 30

                            bat '''
                                curl -f http://localhost:4444/wd/hub/status || (
                                    echo "âŒ Selenium Grid hazÄ±r deÄŸil"
                                    exit 1
                                )
                            '''

                            echo 'ğŸ¯ Dashboard Selenium Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                            bat '''
                                mvn test -Dtest="DashboardSeleniumTest" -DfailIfNoTests=false ^
                                  -Dselenium.grid.url=http://localhost:4444/wd/hub ^
                                  -Dapp.url=http://host.docker.internal:8080/mahkum-nakil ^
                                  -Dspring.main.web-application-type=none ^
                                  -DskipITs=true ^
                                  -DskipUTs=true
                            '''

                            echo 'âœ… Dashboard Selenium testleri baÅŸarÄ±yla tamamlandÄ±'

                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "âš ï¸  DashboardSeleniumTest failed: ${e.message}"

                            bat '''
                                docker-compose logs --tail=200 app > app-dashboard-selenium-error.log 2>&1
                                docker-compose logs --tail=200 selenium-hub > selenium-hub-error.log 2>&1
                                docker-compose logs --tail=200 chrome-node > chrome-node-error.log 2>&1
                                docker-compose ps > docker-ps.log 2>&1
                            '''

                            archiveArtifacts artifacts: '*error.log, docker-ps.log', allowEmptyArchive: true
                            archiveArtifacts artifacts: 'target/screenshots/*.png', allowEmptyArchive: true
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                    archiveArtifacts artifacts: 'nakil-sistemi/*.png', allowEmptyArchive: true
                }
            }
        }
    }

    post {
        always {
            dir('nakil-sistemi') {
                script {
                    echo 'ğŸ§¹ Docker konteynerleri temizleniyor...'
                    bat 'docker-compose down --remove-orphans -v || echo "Docker compose down baÅŸarÄ±sÄ±z"'
                }
            }

            script {
                echo "ğŸ“Š Build Sonucu: ${currentBuild.result}"
                echo "ğŸ“‹ Test SenaryolarÄ± Ã–zeti:"
                echo "  1. AracService Unit Tests"
                echo "  2. MahkumService Unit Tests"
                echo "  3. NakilGoreviService Unit Tests"
                echo "  4. MahkumController Integration Tests"
                echo "  5. MahkumRepository Integration Tests"
                echo "  6. Arac Selenium Tests"
                echo "  7. Dashboard Selenium Tests"

                def testResults = junit testResults: '**/target/surefire-reports/*.xml', allowEmptyResults: true
                if (testResults.totalCount > 0) {
                    echo "ğŸ“ˆ Toplam Test: ${testResults.totalCount}"
                    echo "âœ… BaÅŸarÄ±lÄ± Test: ${testResults.passCount}"
                    echo "âŒ BaÅŸarÄ±sÄ±z Test: ${testResults.failCount}"
                    echo "â­ï¸  Atlanan Test: ${testResults.skipCount}"

                    def successRate = (testResults.passCount / testResults.totalCount) * 100
                    echo "ğŸ¯ BaÅŸarÄ± OranÄ±: ${String.format("%.2f", successRate)}%"
                }

                if (currentBuild.result == 'FAILURE') {
                    echo 'âŒ Pipeline FAILURE ile sonuÃ§landÄ±'
                    error('âŒ Pipeline FAILURE ile sonuÃ§landÄ±!')
                } else if (currentBuild.result == 'UNSTABLE') {
                    echo 'âš ï¸  Pipeline UNSTABLE ile tamamlandÄ± (bazÄ± testler baÅŸarÄ±sÄ±z veya uyarÄ±lar var)'
                } else {
                    echo 'âœ… Pipeline SUCCESS ile tamamlandÄ±!'
                }
            }

            bat 'del /Q *.log 2>nul || echo "Log dosyalarÄ± silinemedi"'
            bat 'del /Q nakil-sistemi\\*.png 2>nul || echo "Screenshot dosyalarÄ± silinemedi"'
        }
    }
}