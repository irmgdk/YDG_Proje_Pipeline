pipeline {
    agent any
    tools {
        jdk 'JDK'
    }
    environment {
        DOCKER_IMAGE_NAME = 'nakil-sistemi'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        MAVEN_OPTS = "-Djacoco.skip=true -Dfile.encoding=UTF-8"
        MAVEN_SETTINGS = "-s .mvn/settings.xml"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo 'âœ… Github kodlarÄ± Ã§ekildi'
            }
        }

        stage('Build') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        bat "mvn clean package -DskipTests ${MAVEN_SETTINGS}"
                    }
                }
            }
        }

        stage('Unit Tests') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo "ğŸ“ Unit Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
                            bat "mvn test -Dtest=\"*Test\" -DskipITs -DskipSeleniumTests ${MAVEN_SETTINGS}"
                        } catch (e) {
                            echo "âš ï¸ Unit Tests failed: ${e.message}"
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Integration Tests') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo "ğŸ”— Integration Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
                            bat "mvn verify -DskipUnitTests -DskipSeleniumTests ${MAVEN_SETTINGS}"
                        } catch (e) {
                            echo "âš ï¸ Integration Tests failed: ${e.message}"
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/failsafe-reports/*.xml'
                }
            }
        }

        stage('Repository Tests') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo "ğŸ—„ï¸ Repository Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
                            bat "mvn test -Dtest=\"*Repository*Test\" -DskipITs -DskipSeleniumTests ${MAVEN_SETTINGS}"
                        } catch (e) {
                            echo "âš ï¸ Repository Tests failed: ${e.message}"
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Docker Run') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    script {
                        echo "ğŸ³ Docker container'larÄ± baÅŸlatÄ±lÄ±yor..."
                        bat 'docker-compose down'
                        bat 'docker-compose up -d'

                        // Sistemlerin hazÄ±r olmasÄ±nÄ± bekle
                        echo "â³ Sistemlerin hazÄ±r olmasÄ± bekleniyor..."

                        // 1. PostgreSQL kontrolÃ¼
                        def postgresReady = false
                        for (int i = 0; i < 12 && !postgresReady; i++) {
                            sleep 5
                            try {
                                def result = bat(
                                    script: 'docker exec mahkum-nakil-db pg_isready -U postgres',
                                    returnStatus: true
                                )
                                if (result == 0) {
                                    postgresReady = true
                                    echo "âœ… PostgreSQL hazÄ±r"
                                }
                            } catch (e) {
                                echo "â³ PostgreSQL hazÄ±r deÄŸil, bekleniyor... ($i/12)"
                            }
                        }

                        // 2. Selenium Grid kontrolÃ¼
                        def seleniumReady = false
                        for (int i = 0; i < 8 && !seleniumReady; i++) {
                            sleep 5
                            try {
                                def status = bat(
                                    script: 'curl -s http://localhost:4444/wd/hub/status || echo "NOT_READY"',
                                    returnStdout: true
                                ).trim()
                                if (status.contains('"ready":true')) {
                                    seleniumReady = true
                                    echo "âœ… Selenium Grid hazÄ±r"
                                } else {
                                    echo "â³ Selenium Grid hazÄ±r deÄŸil, bekleniyor... ($i/8)"
                                }
                            } catch (e) {
                                echo "â³ Selenium Grid eriÅŸilemiyor, bekleniyor... ($i/8)"
                            }
                        }

                        // 3. Uygulama kontrolÃ¼
                        def appReady = false
                        for (int i = 0; i < 15 && !appReady; i++) {
                            sleep 5
                            try {
                                def result = bat(
                                    script: 'curl -s -f http://localhost:8080/actuator/health || echo "NOT_READY"',
                                    returnStdout: true
                                ).trim()
                                if (result.contains('"status":"UP"')) {
                                    appReady = true
                                    echo "âœ… Uygulama hazÄ±r"
                                } else {
                                    echo "â³ Uygulama hazÄ±r deÄŸil, bekleniyor... ($i/15)"
                                }
                            } catch (e) {
                                echo "â³ Uygulama eriÅŸilemiyor, bekleniyor... ($i/15)"
                            }
                        }

                        if (!postgresReady) {
                            echo "âŒ PostgreSQL hazÄ±r deÄŸil!"
                            currentBuild.result = 'FAILURE'
                        }

                        if (!seleniumReady) {
                            echo "âš ï¸ Selenium Grid hazÄ±r deÄŸil, Selenium testleri atlanacak"
                        }

                        if (!appReady) {
                            echo "âš ï¸ Uygulama tam hazÄ±r deÄŸil ama devam ediliyor..."
                        }
                    }
                }
            }
        }

        stage('Selenium Tests') {
            when {
                expression {
                    currentBuild.result != 'FAILURE'
                }
            }
            steps {
                dir('nakil-sistemi') {
                    script {
                        echo "ğŸŒ Selenium Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
                        try {
                            // Son bir Selenium Grid kontrolÃ¼
                            def gridReady = false
                            sleep 3
                            try {
                                def status = bat(
                                    script: 'curl -s -m 10 http://localhost:4444/wd/hub/status || echo "NOT_READY"',
                                    returnStdout: true
                                ).trim()
                                if (status.contains('"ready":true')) {
                                    gridReady = true
                                    echo "âœ… Selenium Grid aktif"
                                } else {
                                    echo "âš ï¸ Selenium Grid yanÄ±t vermiyor: $status"
                                }
                            } catch (e) {
                                echo "âš ï¸ Selenium Grid kontrol hatasÄ±: ${e.message}"
                            }

                            if (gridReady) {
                                // Selenium testlerini Ã§alÄ±ÅŸtÄ±r
                                bat "mvn test -Dtest=\"*SeleniumTest\" -DskipUnitTests -DskipITs ${MAVEN_SETTINGS}"
                            } else {
                                echo "âŒ Selenium Grid hazÄ±r deÄŸil, Selenium testleri atlanÄ±yor"
                                currentBuild.result = 'UNSTABLE'
                            }
                        } catch (e) {
                            echo "âš ï¸ Selenium Tests failed: ${e.message}"
                            currentBuild.result = 'UNSTABLE'

                            // Hata detaylarÄ±nÄ± logla
                            bat 'type target\\surefire-reports\\*SeleniumTest*.txt 2>nul || echo "Selenium test logu bulunamadÄ±"'
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }
    }

    post {
        always {
            dir('nakil-sistemi') {
                script {
                    echo "ğŸ§¹ Docker container'larÄ± temizleniyor..."
                    bat 'docker-compose down || echo "Temizleme hatasÄ±"'

                    // LoglarÄ± topla (opsiyonel)
                    bat 'docker logs mahkum-nakil-app 2>nul | head -100 || echo "App log alÄ±namadÄ±"'
                    bat 'docker logs selenium-hub 2>nul | head -50 || echo "Selenium log alÄ±namadÄ±"'
                }
            }
            script {
                echo "ğŸ“Š Build Result: ${currentBuild.result}"
                if (currentBuild.result == 'FAILURE') {
                    error('âŒ Pipeline failed!')
                } else if (currentBuild.result == 'UNSTABLE') {
                    echo 'âš ï¸ Pipeline completed with warnings'
                } else {
                    echo 'âœ… Pipeline baÅŸarÄ±yla tamamlandÄ±!'
                }
            }
        }
    }
}