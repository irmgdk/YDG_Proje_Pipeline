pipeline {
    agent any
    tools {
        jdk 'JDK'
    }
    environment {
        DOCKER_IMAGE_NAME = 'nakil-sistemi'
        MAVEN_OPTS = "-Dfile.encoding=UTF-8"
        APP_URL = "http://host.docker.internal:8080/mahkum-nakil"
        SELENIUM_GRID_URL = "http://localhost:4444/wd/hub"
    }

    stages {
        // --- 1. Code Pull (5 Points) ---
        stage('1. Checkout') {
            steps {
                checkout scm
                echo '✅ Github codes pulled via Ngrok'
            }
        }

        // --- 2. Build (5 Points) ---
        stage('2. Build Project') {
            steps {
                dir('nakil-sistemi') {
                    bat 'mvn clean compile -DskipTests'
                }
            }
        }

        // --- 3. Unit Tests (15 Points) ---
        stage('3. Unit Tests') {
            stages {
                stage('3.1 Arac Service') {
                    steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=AracServiceTest' } }
                }
                stage('3.2 Mahkum Service') {
                    steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumServiceTest' } }
                }
                stage('3.3 Nakil Service') {
                    steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=NakilGoreviServiceTest' } }
                }
            }
        }

        // --- 4. Integration Tests (15 Points) ---
        stage('4. Integration Tests') {
            stages {
                stage('4.1 Mahkum Controller IT') {
                    steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumControllerIT' } }
                }
                stage('4.2 Repository Integration') {
                    steps { dir('nakil-sistemi') { bat 'mvn test -Dtest=MahkumRepositoryIntegrationTest' } }
                }
            }
        }

        // --- 5. System Run on Docker (5 Points) ---
        stage('5. Docker Deployment') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        bat 'docker-compose down --remove-orphans'
                        bat 'docker-compose build app'
                        bat 'docker-compose up -d'
                        echo '⏳ Waiting for system to stabilize...'
                        sleep 30 // Simple wait for Windows
                    }
                }
            }
        }

        // --- 6. Selenium Test Scenarios (55 Points) ---
        // We use your Arac and Dashboard tests to create the 3 required scenarios
        stage('6. Selenium Scenarios') {
            stages {
                stage('Scenario 1: Vehicle Listing') {
                    steps {
                        dir('nakil-sistemi') {
                            // Runs only the listing test method
                            bat 'mvn test -Dtest=AracSeleniumTest#testAracListPageLoads'
                        }
                    }
                }
                stage('Scenario 2: New Vehicle Entry') {
                    steps {
                        dir('nakil-sistemi') {
                            // Runs only the add test method
                            bat 'mvn test -Dtest=AracSeleniumTest#testAddNewArac'
                        }
                    }
                }
                stage('Scenario 3: Dashboard Overview') {
                    steps {
                        dir('nakil-sistemi') {
                            // Runs the dashboard class
                            bat 'mvn test -Dtest=DashboardSeleniumTest'
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            // This generates the "Status Reported" part of the assignment
            junit allowEmptyResults: true, testResults: 'nakil-sistemi/target/surefire-reports/*.xml'
        }
    }
}
