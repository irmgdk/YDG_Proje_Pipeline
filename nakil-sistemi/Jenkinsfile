pipeline {
    agent any

    tools {
        jdk 'JDK'
    }

    environment {
        APP_DIR           = 'nakil-sistemi'
        DOCKER_IMAGE_NAME = 'nakil-sistemi'
        DOCKER_TAG        = "${env.BUILD_NUMBER}"
        MAVEN_OPTS        = "-Djacoco.skip=true -Dfile.encoding=UTF-8 -DskipSeleniumTests=true"
        SELENIUM_GRID_URL = "http://localhost:4444/wd/hub"
        APP_URL           = "http://host.docker.internal:8080/mahkum-nakil"
        HEALTH_CHECK_URL  = "http://localhost:8080/mahkum-nakil/actuator/health"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo 'âœ… Github kodlarÄ± Ã§ekildi'
            }
        }

        // Parent stage to handle the directory switching once
        stage('Build & Test') {
            // This is the fix: Nesting 'stages' inside a stage
            stages {
                stage('Compile') {
                    steps {
                        dir("${env.APP_DIR}") {
                            bat 'mvn clean compile -DskipSeleniumTests'
                        }
                    }
                }

                stage('Unit Tests') {
                    steps {
                        dir("${env.APP_DIR}") {
                            script {
                                try {
                                    bat 'mvn test -Dtest="*ServiceTest" -DfailIfNoTests=false'
                                } catch (e) {
                                    currentBuild.result = 'UNSTABLE'
                                }
                            }
                        }
                    }
                }

                stage('Integration Tests') {
                    steps {
                        dir("${env.APP_DIR}") {
                            script {
                                try {
                                    bat 'mvn test -Dtest="*IntegrationTest,*IT" -DfailIfNoTests=false'
                                } catch (e) {
                                    currentBuild.result = 'UNSTABLE'
                                }
                            }
                        }
                    }
                }

                stage('Repository Tests') {
                    steps {
                        dir("${env.APP_DIR}") {
                            script {
                                try {
                                    bat 'mvn test -Dtest="*Repository*Test" -DfailIfNoTests=false'
                                } catch (e) {
                                    currentBuild.result = 'UNSTABLE'
                                }
                            }
                        }
                    }
                }

                stage('Package') {
                    when { expression { currentBuild.result != 'FAILURE' } }
                    steps {
                        dir("${env.APP_DIR}") {
                            bat 'mvn package -DskipTests -DskipSeleniumTests'
                        }
                    }
                }
            }
            post {
                always {
                    junit "${env.APP_DIR}/target/surefire-reports/*.xml"
                }
            }
        }

        stage('Docker & Selenium E2E') {
            when { expression { currentBuild.result != 'FAILURE' } }
            steps {
                dir("${env.APP_DIR}") {
                    script {
                        echo 'ðŸ³ Docker setup starting...'
                        bat 'docker-compose down --remove-orphans'
                        bat 'docker-compose build --no-cache app'
                        bat 'docker-compose up -d'

                        echo 'ðŸ©º Waiting for Application Health Check...'
                        def healthCheckPassed = false
                        timeout(time: 5, unit: 'MINUTES') {
                            waitUntil {
                                try {
                                    bat "curl -s -o nul -w \"%%{http_code}\" ${env.HEALTH_CHECK_URL} | findstr /R /C:\"200\""
                                    healthCheckPassed = true
                                    return true
                                } catch (e) {
                                    sleep 5
                                    return false
                                }
                            }
                        }

                        if (healthCheckPassed) {
                            try {
                                bat """
                                    mvn test -Dtest="*SeleniumTest" -DfailIfNoTests=false ^
                                      -Dselenium.grid.url=${env.SELENIUM_GRID_URL} ^
                                      -Dapp.url=${env.APP_URL} ^
                                      -Dspring.main.web-application-type=none ^
                                      -DskipITs=true -DskipUTs=true
                                """
                            } catch (e) {
                                currentBuild.result = 'UNSTABLE'
                                bat 'docker-compose logs --tail=200 app > app-selenium-error.log 2>&1'
                                archiveArtifacts artifacts: '*.log', allowEmptyArchive: true
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            dir("${env.APP_DIR}") {
                bat 'docker-compose down --remove-orphans -v || echo "Cleanup failed"'
            }
            script {
                echo "Final Build Result: ${currentBuild.result}"
            }
            bat 'del /Q *.log 2>nul || echo "Done"'
        }
    }
}