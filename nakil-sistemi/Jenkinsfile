pipeline {
    agent any
    tools {
        jdk 'JDK'
    }
    environment {
        DOCKER_IMAGE_NAME = 'nakil-sistemi'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        MAVEN_OPTS = "-Djacoco.skip=true -Dfile.encoding=UTF-8 -Dfile.encoding=UTF-8 -DskipSeleniumTests=true"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo 'âœ… Github kodlarÄ± Ã§ekildi'
            }
        }

        stage('Build') {
            steps {
                dir('nakil-sistemi') {
                    // Sadece derle, Selenium testlerini atla
                    bat 'mvn clean compile -DskipSeleniumTests'
                    echo 'âœ… Proje baÅŸarÄ±yla derlendi'
                }
            }
        }

        stage('Unit Tests (Service Layer)') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo 'ğŸ§ª Unit Testleri (Service) Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                            // Service testlerini Ã§alÄ±ÅŸtÄ±r
                            bat 'mvn test -Dtest="*ServiceTest" -DfailIfNoTests=false'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "Unit Tests (Service) failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Integration Tests (Controller)') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo 'ğŸ”— Integration Testleri (Controller) Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                            // Controller integration testlerini Ã§alÄ±ÅŸtÄ±r
                            bat 'mvn test -Dtest="*IntegrationTest,*IT" -DfailIfNoTests=false'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "Integration Tests failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Repository Tests') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo 'ğŸ—„ï¸  Repository Testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...'
                            // Repository testlerini Ã§alÄ±ÅŸtÄ±r
                            bat 'mvn test -Dtest="*Repository*Test" -DfailIfNoTests=false'
                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "Repository Tests failed: ${e.message}"
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Package Application') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    echo 'ğŸ“¦ Uygulama paketleniyor...'
                    // TÃ¼m testleri atlayarak paketle (Selenium hariÃ§ zaten Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±)
                    bat 'mvn package -DskipTests -DskipSeleniumTests'
                    echo 'âœ… Uygulama baÅŸarÄ±yla paketlendi'
                }
            }
        }

        stage('Docker Build and Run') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    script {
                        echo 'ğŸ³ Docker konteynerleri hazÄ±rlanÄ±yor...'

                        // Ã–nceki konteynerleri temizle
                        bat 'docker-compose down --remove-orphans'

                        // Yeni imaj oluÅŸtur
                        bat 'docker-compose build --no-cache app'

                        // TÃ¼m servisleri baÅŸlat
                        bat 'docker-compose up -d'

                        // Sistemlerin baÅŸlamasÄ±nÄ± bekle
                        echo 'â³ Sistemlerin baÅŸlamasÄ± bekleniyor (60 saniye)...'
                        sleep 60

                        // Health check'leri kontrol et
                        echo 'ğŸ©º Health check kontrol ediliyor...'
                        bat 'docker-compose ps'

                        // App health check iÃ§in retry mekanizmasÄ±
                        echo 'ğŸ” Uygulama health check yapÄ±lÄ±yor...'
                        script {
                            def healthCheckPassed = false
                            def maxRetries = 12 // 60 saniye (12 * 5 saniye)
                            def retryCount = 0

                            while (!healthCheckPassed && retryCount < maxRetries) {
                                try {
                                    // Windows iÃ§in uygun health check
                                    bat 'curl -s -o nul -w "%%{http_code}" http://localhost:8080/mahkum-nakil/actuator/health | findstr /R /C:"200"'
                                    healthCheckPassed = true
                                    echo 'âœ… Uygulama health check baÅŸarÄ±lÄ±'
                                } catch (Exception e) {
                                    retryCount++
                                    echo "âŒ Health check baÅŸarÄ±sÄ±z (Deneme ${retryCount}/${maxRetries}), 5 saniye bekleniyor..."
                                    sleep 5
                                }
                            }

                            if (!healthCheckPassed) {
                                echo 'âš ï¸  Uygulama health check geÃ§emedi, devam ediliyor...'
                                currentBuild.result = 'UNSTABLE'
                            }

                            // Selenium Grid health check
                            try {
                                bat 'curl -s -o nul -w "%%{http_code}" http://localhost:4444/wd/hub/status | findstr /R /C:"200"'
                                echo 'âœ… Selenium Grid baÅŸarÄ±yla baÅŸladÄ±'
                            } catch (Exception e) {
                                echo 'âš ï¸  Selenium Grid health check baÅŸarÄ±sÄ±z, devam ediliyor...'
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }
            }
        }

        stage('Selenium Tests') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                dir('nakil-sistemi') {
                    script {
                        try {
                            echo 'ğŸš€ Selenium testleri baÅŸlatÄ±lÄ±yor...'

                            // Selenium Grid'in hazÄ±r olduÄŸundan emin ol
                            echo 'â³ Selenium Grid hazÄ±rlanÄ±yor...'
                            sleep 15

                            // Selenium testlerini Ã§alÄ±ÅŸtÄ±r
                            bat 'mvn test -Dtest="*SeleniumTest" -DfailIfNoTests=false -Dselenium.grid.url=http://localhost:4444/wd/hub'

                            echo 'âœ… Selenium testleri baÅŸarÄ±yla tamamlandÄ±'

                        } catch (e) {
                            currentBuild.result = 'UNSTABLE'
                            echo "âš ï¸  Selenium Tests failed: ${e.message}"

                            // Hata durumunda loglarÄ± al
                            echo 'ğŸ“‹ Docker loglarÄ± alÄ±nÄ±yor...'
                            bat 'docker-compose logs --tail=100 app > app.log 2>&1'
                            bat 'docker-compose logs --tail=100 selenium-hub > selenium.log 2>&1'
                            bat 'docker-compose logs --tail=100 chrome-node > chrome.log 2>&1'

                            // LoglarÄ± arÅŸivle
                            archiveArtifacts artifacts: 'app.log, selenium.log, chrome.log', allowEmptyArchive: true
                        }
                    }
                }
            }
            post {
                always {
                    junit 'nakil-sistemi/target/surefire-reports/*.xml'
                    // Ekran gÃ¶rÃ¼ntÃ¼lerini sakla (varsa)
                    archiveArtifacts artifacts: 'nakil-sistemi/*.png', allowEmptyArchive: true
                }
            }
        }
    }

    post {
        always {
            dir('nakil-sistemi') {
                script {
                    echo 'ğŸ§¹ Docker konteynerleri temizleniyor...'
                    // Konteynerleri durdur
                    bat 'docker-compose down --remove-orphans -v || echo "Docker compose down baÅŸarÄ±sÄ±z"'
                }
            }

            script {
                echo "ğŸ“Š Build Sonucu: ${currentBuild.result}"

                // TÃ¼m test raporlarÄ±nÄ± topla
                def testResults = junit testResults: '**/target/surefire-reports/*.xml', allowEmptyResults: true
                if (testResults.totalCount > 0) {
                    echo "Toplam Test: ${testResults.totalCount}"
                    echo "âœ… BaÅŸarÄ±lÄ± Test: ${testResults.passCount}"
                    echo "âŒ BaÅŸarÄ±sÄ±z Test: ${testResults.failCount}"
                    echo "â­ï¸  Atlanan Test: ${testResults.skipCount}"

                    def successRate = (testResults.passCount / testResults.totalCount) * 100
                    echo "ğŸ“ˆ BaÅŸarÄ± OranÄ±: ${String.format("%.2f", successRate)}%"

                    // Test tÃ¼rlerine gÃ¶re ayrÄ±ntÄ±lÄ± rapor
                    echo "ğŸ“‹ Test AÅŸamalarÄ±:"
                    echo "  - Unit Tests (Service): *ServiceTest sÄ±nÄ±flarÄ±"
                    echo "  - Integration Tests: *IntegrationTest ve *IT sÄ±nÄ±flarÄ±"
                    echo "  - Repository Tests: *Repository*Test sÄ±nÄ±flarÄ±"
                    echo "  - Selenium Tests: *SeleniumTest sÄ±nÄ±flarÄ±"
                }

                // SonuÃ§ deÄŸerlendirme
                if (currentBuild.result == 'FAILURE') {
                    echo 'âŒ Pipeline FAILURE ile sonuÃ§landÄ±'
                    error('âŒ Pipeline FAILURE ile sonuÃ§landÄ±!')
                } else if (currentBuild.result == 'UNSTABLE') {
                    echo 'âš ï¸  Pipeline UNSTABLE ile tamamlandÄ± (bazÄ± testler baÅŸarÄ±sÄ±z veya uyarÄ±lar var)'
                } else {
                    echo 'âœ… Pipeline SUCCESS ile tamamlandÄ±!'
                }
            }

            // Temizlik
            bat 'del /Q *.log 2>nul || echo "Log dosyalarÄ± silinemedi"'
            bat 'del /Q nakil-sistemi\\*.png 2>nul || echo "Screenshot dosyalarÄ± silinemedi"'
        }
    }
}