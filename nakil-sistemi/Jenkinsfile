pipeline {
    agent any
    tools {
        jdk 'JDK'
    }
    environment {
        DOCKER_IMAGE_NAME = 'nakil-sistemi'
        MAVEN_OPTS = "-Dfile.encoding=UTF-8"
        // Setup internal host for Windows Docker
        APP_URL = "http://host.docker.internal:8080/mahkum-nakil"
        SELENIUM_GRID_URL = "http://localhost:4444/wd/hub"
    }

    stages {
        // --- 1. Code Pull (5 Points) ---
        stage('1. Checkout') {
            steps {
                checkout scm
                echo '‚úÖ Github Code Pulled'
            }
        }

        // --- 2. Build (5 Points) ---
        stage('2. Build Project') {
            steps {
                dir('nakil-sistemi') {
                    // Compiles the code without running tests yet
                    bat 'mvn clean compile -DskipTests'
                    echo '‚úÖ Project Built Successfully'
                }
            }
        }

        // --- 3. Unit Tests (15 Points) ---
        stage('3. Unit Tests (Service Layer)') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        echo 'üöÄ Running All Service Unit Tests...'
                        // OPTIMIZATION: Running all Service tests in ONE command
                        // This allows Surefire to reuse the JVM, making it 10x faster
                        try {
                            bat 'mvn test -Dtest=AracServiceTest,MahkumServiceTest,NakilGoreviServiceTest'
                        } catch (Exception e) {
                            currentBuild.result = 'UNSTABLE'
                            echo '‚ùå Unit Tests Failed'
                            throw e
                        }
                    }
                }
            }
        }

        // --- 4. Integration Tests (15 Points) ---
        stage('4. Integration Tests') {
            failFast false
            parallel {
                // We run Controller and Repository tests in parallel to save time
                stage('Controller Tests') {
                    steps {
                        dir('nakil-sistemi') {
                            // Runs all methods in MahkumControllerIT at once
                            bat 'mvn test -Dtest=MahkumControllerIT'
                        }
                    }
                }
                stage('Repository Tests') {
                    steps {
                        dir('nakil-sistemi') {
                            // Runs all methods in MahkumRepositoryIntegrationTest at once
                            bat 'mvn test -Dtest=MahkumRepositoryIntegrationTest'
                        }
                    }
                }
            }
        }

        // --- Package Application ---
        stage('Package Jar') {
            when { expression { currentBuild.result != 'FAILURE' } }
            steps {
                dir('nakil-sistemi') {
                    // Package without running tests again (they already passed)
                    bat 'mvn package -DskipTests'
                }
            }
        }

        // --- 5. System Run on Docker (5 Points) ---
        stage('5. Docker Deployment') {
            when { expression { currentBuild.result != 'FAILURE' } }
            steps {
                dir('nakil-sistemi') {
                    script {
                        echo 'üê≥ Refreshing Docker Containers...'
                        bat 'docker-compose down --remove-orphans'
                        bat 'docker-compose build --no-cache app'
                        bat 'docker-compose up -d'

                        // OPTIMIZATION: Intelligent Wait loop instead of hardcoded sleep
                        echo '‚è≥ Waiting for application to start...'
                        def healthCheckPassed = false
                        def retryCount = 0

                        // Try for up to 60 seconds (12 * 5s)
                        while (!healthCheckPassed && retryCount < 12) {
                            sleep 5
                            try {
                                // Checks if the actuator health endpoint returns 200 OK
                                bat 'curl -s -f -o nul http://localhost:8080/mahkum-nakil/actuator/health'
                                healthCheckPassed = true
                                echo '‚úÖ App is UP and READY!'
                            } catch (Exception e) {
                                retryCount++
                                echo "Still waiting... (${retryCount}/12)"
                            }
                        }

                        if (!healthCheckPassed) {
                            error "‚ùå Application failed to start within 60 seconds."
                        }
                    }
                }
            }
        }

        // --- 6. Selenium Test Scenarios (55 Points + Bonus) ---
        // The assignment allows separate stages here, which is good for reporting.
        // We group them by Class (Scenario) rather than by Method.
        stage('6. Selenium E2E Scenarios') {
            when { expression { currentBuild.result != 'FAILURE' } }
            stages {
                stage('Scenario Set A: Arac Operations') {
                    steps {
                        dir('nakil-sistemi') {
                            // Runs all 4 Arac scenarios (List, Add, Search, Toggle) in one go
                            bat 'mvn test -Dtest=AracSeleniumTest'
                        }
                    }
                }
                stage('Scenario Set B: Dashboard Checks') {
                    steps {
                        dir('nakil-sistemi') {
                            // Runs all Dashboard scenarios (Home, Stats, Nav) in one go
                            bat 'mvn test -Dtest=DashboardSeleniumTest'
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            // Generates the report required by the assignment
            junit allowEmptyResults: true, testResults: 'nakil-sistemi/target/surefire-reports/*.xml'
            echo 'üìù Test results archived.'
        }
        cleanup {
            // Optional: Tear down docker to save resources on your laptop
            // dir('nakil-sistemi') { bat 'docker-compose down' }
        }
    }
}