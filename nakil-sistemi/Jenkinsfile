pipeline {
    agent any

    parameters {
        string(name: 'DOCKER_TAG', defaultValue: 'latest', description: 'Docker imaj etiketi')
        booleanParam(name: 'RUN_SELENIUM', defaultValue: true, description: 'Selenium testleri Ã§alÄ±ÅŸtÄ±rÄ±lsÄ±n mÄ±?')
    }

    tools {
        jdk 'JDK'
        maven 'Maven' // Maven'Ä± global tool olarak tanÄ±mlamak daha profesyoneldir
    }

    environment {
        DOCKER_IMAGE = 'nakil-sistemi'
        MAVEN_ARGS = "-Djacoco.skip=true -Dfile.encoding=UTF-8 -DskipSeleniumTests=true"
        APP_URL = "http://host.docker.internal:8080/mahkum-nakil"
    }

    options {
        timeout(time: 1, unit: 'HOURS') // Pipeline'Ä±n asÄ±lÄ± kalmasÄ±nÄ± Ã¶nler
        timestamps() // Loglarda zaman damgasÄ± gÃ¶sterir
        buildDiscarder(logRotator(numToKeepStr: '10')) // Eski buildleri temizler
    }

    stages {
        stage('Initial Cleanup') {
            steps {
                echo 'ğŸ§¹ Temizlik yapÄ±lÄ±yor...'
                deleteDir() // Ã‡alÄ±ÅŸma alanÄ±nÄ± temizle
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
                echo 'âœ… Kaynak kod Ã§ekildi.'
            }
        }

        stage('Build & Unit Tests') {
            steps {
                dir('nakil-sistemi') {
                    echo 'ğŸ“¦ Derleme ve Birim Testler...'
                    bat "mvn clean install ${MAVEN_ARGS} -Dtest=*ServiceTest"
                }
            }
        }

        stage('Integration & Repository Tests') {
            parallel { // Test sÃ¼resini kÄ±saltmak iÃ§in paralel koÅŸturulabilir
                stage('Controller Tests') {
                    steps {
                        dir('nakil-sistemi') {
                            bat 'mvn test -Dtest="*IntegrationTest,*IT" -DfailIfNoTests=false'
                        }
                    }
                }
                stage('Repo Tests') {
                    steps {
                        dir('nakil-sistemi') {
                            bat 'mvn test -Dtest="*Repository*Test" -DfailIfNoTests=false'
                        }
                    }
                }
            }
        }

        stage('Docker Preparation') {
            steps {
                dir('nakil-sistemi') {
                    echo 'ğŸ³ Docker imajÄ± hazÄ±rlanÄ±yor...'
                    bat 'docker-compose down --remove-orphans'
                    bat "docker build -t ${DOCKER_IMAGE}:${env.BUILD_NUMBER} ."
                    bat 'docker-compose up -d'
                }
            }
        }

        stage('Health Check') {
            steps {
                script {
                    echo 'ğŸ©º Uygulama ayaÄŸa kalkÄ±yor mu?'
                    timeout(time: 5, unit: 'MINUTES') {
                        waitUntil {
                            def response = bat(returnStatus: true, script: "curl -s --fail ${APP_URL}/actuator/health")
                            return (response == 0)
                        }
                    }
                    echo 'âœ… Uygulama saÄŸlÄ±klÄ±.'
                }
            }
        }

        stage('Selenium E2E Tests') {
            when { expression { return params.RUN_SELENIUM } }
            steps {
                dir('nakil-sistemi') {
                    echo 'ğŸš€ Selenium Grid Testleri baÅŸlatÄ±lÄ±yor...'
                    bat """
                        mvn test -Dtest="*SeleniumTest" ^
                        -Dselenium.grid.url=http://localhost:4444/wd/hub ^
                        -Dapp.url=${APP_URL} ^
                        -Dspring.main.web-application-type=none
                    """
                }
            }
        }
    }

    post {
        always {
            script {
                echo 'ğŸ“Š Raporlar toplanÄ±yor...'
                junit '**/target/surefire-reports/*.xml'

                echo 'ğŸ§¹ Docker ortamÄ± kapatÄ±lÄ±yor...'
                dir('nakil-sistemi') {
                    bat 'docker-compose down -v'
                }
            }
        }
        success {
            echo 'ğŸ‰ Tebrikler! Pipeline baÅŸarÄ±yla tamamlandÄ±.'
        }
        failure {
            echo 'âŒ Pipeline baÅŸarÄ±sÄ±z oldu. LÃ¼tfen loglarÄ± ve test raporlarÄ±nÄ± inceleyin.'
            archiveArtifacts artifacts: '**/app-selenium-error.log, **/target/screenshots/*.png', allowEmptyArchive: true
        }
    }
}