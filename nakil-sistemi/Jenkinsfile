pipeline {
    agent any
    tools {
        jdk 'JDK'
    }
    environment {
        DOCKER_IMAGE_NAME = 'nakil-sistemi'
        MAVEN_OPTS = "-Dfile.encoding=UTF-8"
        // Uses internal docker networking (Standard for Windows)
        APP_URL = "http://host.docker.internal:8080/mahkum-nakil"
        SELENIUM_GRID_URL = "http://localhost:4444/wd/hub"
    }

    stages {
        // --- 1. Code Pull (5 Points) ---
        stage('1. Checkout') {
            steps {
                checkout scm
                echo '‚úÖ Github Code Pulled via Ngrok Trigger'
            }
        }

        // --- 2. Build (5 Points) ---
        stage('2. Build Project') {
            steps {
                dir('nakil-sistemi') {
                    // Compiles once. Fast.
                    bat 'mvn clean compile -DskipTests'
                    echo '‚úÖ Project Built'
                }
            }
        }

        // --- 3. Unit Tests (15 Points) ---
        stage('3. Unit Tests (Service Layer)') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        echo 'üöÄ Running Service Tests...'
                        // runs ALL service tests in one go (Very Fast)
                        bat 'mvn test -Dtest=AracServiceTest,MahkumServiceTest,NakilGoreviServiceTest'
                    }
                }
            }
        }

        // --- 4. Integration Tests (15 Points) ---
        stage('4. Integration Tests') {
            // Runs Controller and Repository tests at the same time
            parallel {
                stage('Controller Tests') {
                    steps {
                        dir('nakil-sistemi') {
                            bat 'mvn test -Dtest=MahkumControllerIT'
                        }
                    }
                }
                stage('Repository Tests') {
                    steps {
                        dir('nakil-sistemi') {
                            bat 'mvn test -Dtest=MahkumRepositoryIntegrationTest'
                        }
                    }
                }
            }
        }

        // --- Package Application (Hidden Helper Step) ---
        stage('Package Jar') {
            when { expression { currentBuild.result != 'FAILURE' } }
            steps {
                dir('nakil-sistemi') {
                    bat 'mvn package -DskipTests'
                }
            }
        }

        // --- 5. System Run on Docker (5 Points) ---
        stage('5. Docker Deployment') {
            steps {
                dir('nakil-sistemi') {
                    script {
                        echo 'üê≥ Restarting Docker...'
                        bat 'docker-compose down --remove-orphans'
                        bat 'docker-compose build --no-cache app'
                        bat 'docker-compose up -d'

                        echo '‚è≥ Waiting for app (Smart Check)...'
                        // Loops until app is ready (max 2 mins)
                        timeout(time: 2, unit: 'MINUTES') {
                            waitUntil {
                                script {
                                    try {
                                        // Checks if the app is alive
                                        def status = bat(returnStdout: true, script: 'curl -s -o nul -w "%{http_code}" http://localhost:8080/mahkum-nakil/actuator/health').trim()
                                        return status == '200'
                                    } catch (Exception e) {
                                        return false
                                    }
                                }
                            }
                        }
                        echo '‚úÖ App is UP!'
                    }
                }
            }
        }

        // --- 6. Selenium Test Scenarios (55 Points) ---
        stage('6. Selenium Scenarios') {
            stages {
                stage('Scenario Set A: Arac') {
                    steps {
                        dir('nakil-sistemi') {
                            // Runs all Arac Selenium tests
                            bat 'mvn test -Dtest=AracSeleniumTest'
                        }
                    }
                }
                stage('Scenario Set B: Dashboard') {
                    steps {
                        dir('nakil-sistemi') {
                            // Runs all Dashboard Selenium tests
                            bat 'mvn test -Dtest=DashboardSeleniumTest'
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            junit allowEmptyResults: true, testResults: 'nakil-sistemi/target/surefire-reports/*.xml'
        }
    }
}